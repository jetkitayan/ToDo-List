<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ToDo 管理（Workers + D1）</title>
  <style>
    :root{--bg:#fafafa;--fg:#111;--muted:#666;--line:#ddd;--primary:#2563eb;--ok:#16a34a;--danger:#dc2626}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);padding:12px 16px;z-index:10}
    h1{margin:0;font-size:18px}
    .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:16px;margin:16px}
    label{font-size:12px;color:var(--muted)}
    input,select,textarea,button{font:inherit}
    input[type="text"], input[type="date"], input[type="number"], textarea, select{border:1px solid var(--line);border-radius:10px;padding:8px 10px;background:#fff}
    textarea{width:100%;min-height:70px}
    button{border:1px solid var(--line);background:#fff;border-radius:999px;padding:8px 14px;cursor:pointer}
    .btn{border-color:transparent;background:var(--primary);color:#fff}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn-danger{background:var(--danger);color:#fff;border-color:transparent}
    .btn-ghost{background:#fff}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--line);padding:10px;text-align:left;vertical-align:top}
    th{font-size:12px;color:var(--muted)}
    .strike{text-decoration:line-through;color:#999}
    .right{margin-left:auto}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px}
    .chips{display:flex;flex-wrap:wrap;gap:6px}
    .chip{font-size:12px;border:1px solid var(--line);border-radius:999px;padding:2px 8px;color:var(--muted)}
    .counts{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <div class="row">
      <h1>ToDo 管理</h1>
      <span class="right counts" id="counts">—</span>
    </div>
    <div class="row" style="margin-top:8px">
      <div class="row" style="gap:6px">
        <label>API</label>
        <input id="apiBase" type="text" value="https://memo-save-api.jetkitayan.workers.dev" />
        <label>ユーザー</label>
        <input id="authUser" type="text" size="10" />
        <label>パス</label>
        <input id="authPass" type="password" size="10" />
        <button id="saveCfg" class="btn-ghost">保存</button>
      </div>
      <div class="row right" style="gap:6px">
        <label>表示</label>
        <select id="filterDone">
          <option value="0">未完のみ</option>
          <option value="all">すべて</option>
          <option value="1">完了のみ</option>
        </select>
        <label>並び</label>
        <select id="sort">
          <option value="default">更新順（未完→完了）</option>
          <option value="due">期限順</option>
          <option value="priority">優先度順</option>
        </select>
        <label>検索</label>
        <input id="q" type="text" size="14" placeholder="キーワード" />
        <button id="reload" class="btn-ghost">再読込</button>
      </div>
    </div>
  </header>

  <section class="card">
    <h2 style="margin:0 0 12px 0;font-size:16px">新規追加</h2>
    <div class="row" style="gap:8px;margin-bottom:8px">
      <input id="title" type="text" placeholder="タイトル（任意）" size="24" />
      <input id="dueAt" type="date" />
      <select id="priority">
        <option value="0">優先度: 0（通常）</option>
        <option value="1">1（高）</option>
        <option value="2">2（最優先）</option>
        <option value="-1">-1（低）</option>
      </select>
      <button id="add" class="btn">追加</button>
    </div>
    <textarea id="text" placeholder="やることの本文"></textarea>
  </section>

  <section class="card" style="padding-top:6px">
    <table>
      <thead>
        <tr>
          <th style="width:36px">完了</th>
          <th>本文</th>
          <th style="width:170px">期限/優先</th>
          <th style="width:220px">更新</th>
          <th style="width:120px">操作</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </section>

<script>
(function(){
  // ★ 既定のAPI（メモ管理と同じく固定）
  const API_BASE = 'https://memo-save-api.jetkitayan.workers.dev';

  const els = {
    apiBase: document.getElementById('apiBase'),
    authUser: document.getElementById('authUser'),
    authPass: document.getElementById('authPass'),
    saveCfg: document.getElementById('saveCfg'),
    filterDone: document.getElementById('filterDone'),
    sort: document.getElementById('sort'),
    q: document.getElementById('q'),
    reload: document.getElementById('reload'),
    title: document.getElementById('title'),
    text: document.getElementById('text'),
    dueAt: document.getElementById('dueAt'),
    priority: document.getElementById('priority'),
    add: document.getElementById('add'),
    tbody: document.getElementById('tbody'),
    counts: document.getElementById('counts'),
  };

  // --- 設定をlocalStorageに保存 ---
  const LS_KEY = 'todo_cfg_v1';
  function loadCfg(){
    try{
      const o = JSON.parse(localStorage.getItem(LS_KEY) || '{}');
      // ★ 未保存なら既定APIを自動使用
      els.apiBase.value = o.apiBase || API_BASE;
      els.authUser.value = o.user || '';
      els.authPass.value = o.pass || '';
      els.filterDone.value = o.done || '0';
      els.sort.value = o.sort || 'default';
      els.q.value = o.q || '';
    }catch{}
  }
  function saveCfg(){
    const o = {
      apiBase: els.apiBase.value.trim(),
      user: els.authUser.value.trim(),
      pass: els.authPass.value,
      done: els.filterDone.value,
      sort: els.sort.value,
      q: els.q.value.trim(),
    };
    localStorage.setItem(LS_KEY, JSON.stringify(o));
  }
  loadCfg();

  els.saveCfg.addEventListener('click', ()=>{ saveCfg(); alert('設定を保存しました'); });
  ['change','keyup'].forEach(ev=>{
    els.filterDone.addEventListener(ev, saveCfg);
    els.sort.addEventListener(ev, saveCfg);
    els.q.addEventListener(ev, e=>{ if(e.key==='Enter') reload(); else saveCfg(); });
  });

  function authHeader(){
    const u = els.authUser.value.trim();
    const p = els.authPass.value;
    return u ? { 'Authorization': 'Basic ' + btoa(u + ':' + p) } : {};
  }

  function api(path, opts={}){
    // ★ 入力が空でも既定APIでフォールバック
    const base = (els.apiBase.value.trim() || API_BASE).replace(/\/$/, '');
    const headers = { 'Content-Type': 'application/json', ...authHeader(), ...(opts.headers||{}) };
    return fetch(base + path, { ...opts, headers });
  }

  async function reload(){
    const q = new URLSearchParams();
    const done = els.filterDone.value;
    if(done !== 'all') q.set('done', done);
    if(els.q.value.trim()) q.set('query', els.q.value.trim());
    q.set('sort', els.sort.value);
    q.set('limit','100');

    const res = await api('/api/todos?' + q.toString());
    if(!res.ok){ console.error(await res.text()); alert('読み込みに失敗しました'); return; }
    const data = await res.json();
    render(data.todos || data); // サーバ実装によってどちらでも拾えるように
  }

  function fmtDate(s){ if(!s) return ''; return s.replace('T',' ').replace('Z',''); }

  function render(items){
    els.tbody.innerHTML = '';
    let todo = 0, done = 0, overdue = 0;
    const today = new Date();
    items.forEach(it=>{ if(it.done) done++; else todo++; });

    for(const it of items){
      const tr = document.createElement('tr');

      // 完了チェック
      const td0 = document.createElement('td');
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.checked = !!it.done;
      cb.addEventListener('change', ()=> toggleDone(it.id, cb.checked));
      td0.appendChild(cb);

      // 本文
      const td1 = document.createElement('td');
      const title = document.createElement('div');
      title.textContent = it.title || '(無題)';
      title.style.fontWeight = '600';
      const text = document.createElement('div');
      text.textContent = it.text || '';
      if(it.done){ title.classList.add('strike'); text.classList.add('strike'); }
      td1.append(title, text);

      // 期限/優先
      const td2 = document.createElement('td');
      const due = document.createElement('div');
      due.textContent = it.due_at ? ('期限: ' + it.due_at.slice(0,10)) : '期限: —';
      const pr = document.createElement('div');
      pr.textContent = '優先度: ' + (Number.isFinite(it.priority) ? it.priority : 0);
      td2.append(due, pr);
      if(it.due_at && !it.done){
        const d = new Date(it.due_at);
        if(d.setHours(0,0,0,0) < today.setHours(0,0,0,0)) { overdue++; }
      }

      // 更新情報
      const td3 = document.createElement('td');
      const up = document.createElement('div'); up.textContent = '更新: ' + fmtDate(it.updated_at || '');
      const dn = document.createElement('div'); dn.textContent = it.done_at ? ('完了: ' + fmtDate(it.done_at)) : '';
      td3.append(up, dn);

      // 操作
      const td4 = document.createElement('td');
      const btnDel = document.createElement('button'); btnDel.className='btn-danger'; btnDel.textContent='削除';
      btnDel.onclick = ()=> delTodo(it.id);
      td4.append(btnDel);

      tr.append(td0, td1, td2, td3, td4);
      els.tbody.appendChild(tr);
    }
    els.counts.textContent = `未完 ${todo} / 完了 ${done}` + (overdue? ` / 期限切れ ${overdue}`: '');
  }

  async function add(){
    const payload = {
      title: els.title.value.trim() || null,
      text: els.text.value.trim(),
      dueAt: els.dueAt.value ? els.dueAt.value + 'T00:00:00Z' : null,
      priority: Number(els.priority.value)||0,
      tags: [],
    };
    if(!payload.text){ alert('本文を入力してください'); return; }
    const res = await api('/api/todos', { method:'POST', body: JSON.stringify(payload) });
    if(!res.ok){ alert('追加に失敗しました'); return; }
    els.text.value=''; els.title.value=''; els.dueAt.value=''; els.priority.value='0';
    reload();
  }

  async function toggleDone(id, v){
    const res = await api('/api/todos/'+id, { method:'PATCH', body: JSON.stringify({ done: !!v }) });
    if(!res.ok){ alert('更新に失敗しました'); return; }
    reload();
  }

  async function delTodo(id){
    if(!confirm('削除しますか？')) return;
    const res = await api('/api/todos/'+id, { method:'DELETE' });
    if(!res.ok){ alert('削除に失敗しました'); return; }
    reload();
  }

  // UIイベント
  els.add.addEventListener('click', add);
  els.reload.addEventListener('click', reload);
  ['change'].forEach(ev=>{
    els.filterDone.addEventListener(ev, reload);
    els.sort.addEventListener(ev, reload);
  });

  // ★ 初回も既定APIを反映（空なら上書き）
  if(!els.apiBase.value){ els.apiBase.value = API_BASE; }
  reload();
})();
</script>
</body>
</html>
