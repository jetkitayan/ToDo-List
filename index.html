<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ToDo 管理（Workers + D1）</title>
  <style>
    :root{--bg:#fafafa;--fg:#111;--muted:#666;--line:#ddd;--primary:#2563eb;--ok:#16a34a;--danger:#dc2626}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);padding:12px 16px;z-index:10}
    h1{margin:0;font-size:18px}
    .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:16px;margin:16px}
    label{font-size:12px;color:var(--muted)}
    input,textarea,button{font:inherit}
    input[type="text"], textarea{border:1px solid var(--line);border-radius:10px;padding:8px 10px;background:#fff}
    textarea{width:100%;min-height:70px}
    button{border:1px solid var(--line);background:#fff;border-radius:999px;padding:8px 14px;cursor:pointer}
    .btn{border-color:transparent;background:var(--primary);color:#fff}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn-danger{background:var(--danger);color:#fff;border-color:transparent}
    .btn-ghost{background:#fff}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--line);padding:10px;text-align:left;vertical-align:top}
    th{font-size:12px;color:var(--muted)}
    .strike{text-decoration:line-through;color:#999}
    .right{margin-left:auto}
    .counts{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <div class="row">
      <h1>ToDo 管理</h1>
      <span class="right counts" id="counts">—</span>
    </div>
    <div class="row right" style="gap:6px;margin-top:8px">
      <label>表示</label>
      <select id="filterDone">
        <option value="0">未完のみ</option>
        <option value="all">すべて</option>
        <option value="1">完了のみ</option>
      </select>
      <label>検索</label>
      <input id="q" type="text" size="14" placeholder="キーワード" />
      <button id="reload" class="btn-ghost">再読込</button>
    </div>
  </header>

  <section class="card">
    <h2 style="margin:0 0 12px 0;font-size:16px">新規追加</h2>
    <div class="row" style="gap:8px;margin-bottom:8px">
      <select id="category">
        <option value="仕事">仕事</option>
        <option value="プライベート">プライベート</option>
        <option value="勉強">勉強</option>
        <option value="その他" selected>その他</option>
      </select>
      <button id="add" class="btn">追加</button>
    </div>
    <textarea id="text" placeholder="やることの本文"></textarea>
  </section>

  <section class="card" style="padding-top:6px">
    <table>
      <thead>
        <tr>
          <th style="width:36px">完了</th>
          <th>本文</th>
          <th style="width:220px">更新</th>
          <th style="width:120px">操作</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </section>

<script>
const editing = new Set();

(function(){
  const API_BASE = 'https://memo-save-api.jetkitayan.workers.dev';
  const USER = 'jet-pay';
  const PASS = 'kibare@1002';

  const els = {
    filterDone: document.getElementById('filterDone'),
    q: document.getElementById('q'),
    reload: document.getElementById('reload'),
    category: document.getElementById('category'),
    text: document.getElementById('text'),
    add: document.getElementById('add'),
    tbody: document.getElementById('tbody'),
    counts: document.getElementById('counts'),
  };

  function authHeader(){
    return USER ? { 'Authorization': 'Basic ' + btoa(USER + ':' + PASS) } : {};
  }

  function api(path, opts={}){
    const headers = { 'Content-Type': 'application/json', ...authHeader(), ...(opts.headers||{}) };
    return fetch(API_BASE + path, { ...opts, headers });
  }

  async function reload(){
    const q = new URLSearchParams();
    q.set('done', els.filterDone.value);
    if(els.q.value.trim()) q.set('query', els.q.value.trim());
    q.set('sort','default');
    q.set('limit','100');

    const res = await api('/api/todos?' + q.toString());
    if(!res.ok){ console.error(await res.text()); alert('読み込みに失敗しました'); return; }
    const data = await res.json();
    render(data.todos || data);
  }

  function fmtDate(s){ if(!s) return ''; return s.replace('T',' ').replace('Z',''); }

  function render(items){
    els.tbody.innerHTML = '';
    let todo = 0, done = 0;
    items.forEach(it=>{ if(it.done) done++; else todo++; });

    for(const it of items){
      const tr = document.createElement('tr');

      // 完了チェック
      const td0 = document.createElement('td');
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.checked = !!it.done;
      cb.addEventListener('change', ()=> toggleDone(it.id, cb.checked));
      td0.appendChild(cb);

      const isEdit = editing.has(it.id);

      // 本文
      const td1 = document.createElement('td');
      if(isEdit){
        const titleI = document.createElement('input');
        titleI.type = 'text';
        titleI.value = it.title || '';
        titleI.style.fontWeight = '600';
        titleI.style.display = 'block';
        titleI.style.marginBottom = '6px';

        const textI = document.createElement('textarea');
        textI.value = it.text || '';
        textI.style.width = '100%';

        td1.append(titleI, textI);
        td1.dataset.role = 'edit-main';
      }else{
        const title = document.createElement('div');
        title.textContent = it.title || '(無題)';
        title.style.fontWeight = '600';
        const text = document.createElement('div');
        text.textContent = it.text || '';
        if(it.done){ title.classList.add('strike'); text.classList.add('strike'); }
        td1.append(title, text);
      }

      // 更新情報
      const td3 = document.createElement('td');
      const up = document.createElement('div'); up.textContent = '更新: ' + fmtDate(it.updated_at || '');
      const dn = document.createElement('div'); dn.textContent = it.done_at ? ('完了: ' + fmtDate(it.done_at)) : '';
      td3.append(up, dn);

      // 操作
      const td4 = document.createElement('td');
      if(isEdit){
        const btnSave = document.createElement('button'); btnSave.className='btn'; btnSave.textContent='保存';
        btnSave.onclick = ()=> saveEdit(it.id, tr);
        const btnCancel = document.createElement('button'); btnCancel.className='btn-ghost'; btnCancel.style.marginLeft='6px'; btnCancel.textContent='取消';
        btnCancel.onclick = ()=> { editing.delete(it.id); reload(); };
        td4.append(btnSave, btnCancel);
      }else{
        const btnEdit = document.createElement('button'); btnEdit.className='btn-ghost'; btnEdit.textContent='編集';
        btnEdit.onclick = ()=> { editing.add(it.id); reload(); };
        const btnDel = document.createElement('button'); btnDel.className='btn-danger'; btnDel.style.marginLeft='6px'; btnDel.textContent='削除';
        btnDel.onclick = ()=> delTodo(it.id);
        td4.append(btnEdit, btnDel);
      }

      tr.append(td0, td1, td3, td4);
      els.tbody.appendChild(tr);
    }
    els.counts.textContent = `未完 ${todo} / 完了 ${done}`;
  }

  async function add(){
    const payload = {
      title: els.category.value,        // ← 分類を title に保存
      text: els.text.value.trim(),
    };
    if(!payload.text){ alert('本文を入力してください'); return; }
    const res = await api('/api/todos', { method:'POST', body: JSON.stringify(payload) });
    if(!res.ok){ alert('追加に失敗しました'); return; }
    els.text.value='';
    els.category.value = 'その他';      // ← 初期化
    reload();
  }

  async function toggleDone(id, v){
    const res = await api('/api/todos/'+id, { method:'PATCH', body: JSON.stringify({ done: !!v }) });
    if(!res.ok){ alert('更新に失敗しました'); return; }
    reload();
  }

  async function delTodo(id){
    if(!confirm('削除しますか？')) return;
    const res = await api('/api/todos/'+id, { method:'DELETE' });
    if(!res.ok){ alert('削除に失敗しました'); return; }
    reload();
  }

  async function saveEdit(id, tr){
    const main = tr.querySelector('td[data-role="edit-main"]');
    const [titleI, textI] = main.querySelectorAll('input,textarea');

    const payload = {
      title: (titleI.value || null),
      text: (textI.value || ''),
    };

    const res = await api('/api/todos/'+id, { method:'PATCH', body: JSON.stringify(payload) });
    if(!res.ok){ alert('保存に失敗しました'); return; }
    editing.delete(id);
    reload();
  }

  els.add.addEventListener('click', add);
  els.reload.addEventListener('click', reload);
  els.filterDone.addEventListener('change', reload);
  document.getElementById('q').addEventListener('keydown', e=>{ if(e.key==='Enter') reload(); });

  reload();
})();
</script>
</body>
</html>
